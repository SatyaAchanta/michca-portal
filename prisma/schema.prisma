generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Division {
  F40
  PREMIER_T20
  DIV1_T20
  DIV2_T20
  DIV3_T20
  T30
  U15
  GLT
}

enum GameType {
  LEAGUE
  PLAYOFF
}

enum GameStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

enum UserRole {
  PLAYER
  UMPIRE
  ADMIN
}

enum UmpiringTrainingResult {
  PENDING
  PASS
  FAIL
}

enum CertificationWindowStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum CertificationAttemptStatus {
  IN_PROGRESS
  SUBMITTED
  TIME_EXPIRED
}

enum CertificationAttemptResult {
  PASS
  FAIL
}

enum DietaryPreference {
  VEGETARIAN
  NON_VEGETARIAN
}

enum UmpiringTrainingDateOption {
  MARCH_28_2026
  MARCH_29_2026
}

model Team {
  shortCode    String @id
  name         String
  gamesAsTeam1 Game[] @relation("Team1")
  gamesAsTeam2 Game[] @relation("Team2")
  gamesWon     Game[] @relation("GameWinner")
}

model Game {
  id                String             @id @default(uuid())
  date              DateTime
  division          Division
  league            String
  status            GameStatus         @default(SCHEDULED)
  venue             String?
  team1ShortCode    String
  team2ShortCode    String
  team1             Team               @relation("Team1", fields: [team1ShortCode], references: [shortCode])
  team2             Team               @relation("Team2", fields: [team2ShortCode], references: [shortCode])
  gameType          GameType           @default(LEAGUE)
  winnerShortCode   String?
  winner            Team?              @relation("GameWinner", fields: [winnerShortCode], references: [shortCode])
  isDraw            Boolean            @default(false)
  isCancelled       Boolean            @default(false)
  team1Score        Int?
  team2Score        Int?
  resultNotes       String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  umpireAssignments UmpireAssignment[]

  @@index([date])
  @@index([status])
}

model UserProfile {
  id                   String             @id @default(uuid())
  clerkUserId          String             @unique
  email                String
  firstName            String?
  lastName             String?
  notificationsEnabled Boolean            @default(true)
  newsletterSubscribed Boolean            @default(false)
  role                 UserRole           @default(PLAYER)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  umpireAssignments    UmpireAssignment[]
  umpiringTraining     UmpiringTraining?
  certificationQuestionsCreated CertificationQuestion[] @relation("CertificationQuestionCreatedBy")
  certificationWindowsStarted   CertificationTestWindow[] @relation("CertificationWindowStartedBy")
  certificationAttempts         CertificationAttempt[]

  @@index([email])
  @@index([role])
}

model UmpiringTraining {
  id                  String                 @id @default(uuid())
  userProfileId       String                 @unique
  firstName           String?
  lastName            String?
  email               String
  contactNumber       String
  dietaryPreference   DietaryPreference      @default(VEGETARIAN)
  previouslyCertified Boolean
  affiliation         String?
  preferredDates      UmpiringTrainingDateOption[]
  preferredLocation   String
  questions           String?
  result              UmpiringTrainingResult @default(PENDING)
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  userProfile         UserProfile            @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@index([result])
  @@index([createdAt])
  @@index([preferredDates])
}

model UmpireAssignment {
  id         String      @id @default(uuid())
  gameId     String
  umpireId   String
  assignedAt DateTime    @default(now())
  game       Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  umpire     UserProfile @relation(fields: [umpireId], references: [id], onDelete: Cascade)

  @@unique([gameId, umpireId])
  @@index([umpireId])
  @@index([gameId])
}

model CertificationQuestion {
  id              String                        @id @default(uuid())
  prompt          String
  isActive        Boolean                       @default(true)
  createdByUserId String
  createdBy       UserProfile                   @relation("CertificationQuestionCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  options         CertificationQuestionOption[]
  createdAt       DateTime                      @default(now())
  updatedAt       DateTime                      @updatedAt

  @@index([isActive])
  @@index([createdByUserId])
}

model CertificationQuestionOption {
  id         String                @id @default(uuid())
  questionId String
  question   CertificationQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  label      String
  isCorrect  Boolean
  sortOrder  Int
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt

  @@index([questionId])
  @@unique([questionId, sortOrder])
}

model CertificationTestWindow {
  id              String                    @id @default(uuid())
  location        String
  testDateLocal   DateTime                  @db.Date
  status          CertificationWindowStatus @default(DRAFT)
  durationMinutes Int                       @default(30)
  questionCount   Int                       @default(20)
  startedByUserId String
  startedBy       UserProfile               @relation("CertificationWindowStartedBy", fields: [startedByUserId], references: [id], onDelete: Restrict)
  startedAt       DateTime                  @default(now())
  closedAt        DateTime?
  attempts        CertificationAttempt[]
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@unique([location, testDateLocal])
  @@index([status])
  @@index([testDateLocal])
}

model CertificationAttempt {
  id            String                     @id @default(uuid())
  windowId      String
  userProfileId String
  startedAt     DateTime                   @default(now())
  expiresAt     DateTime
  submittedAt   DateTime?
  status        CertificationAttemptStatus @default(IN_PROGRESS)
  scorePercent  Int?
  correctCount  Int?
  totalQuestions Int
  result        CertificationAttemptResult?
  snapshotVersion Int                      @default(1)
  window        CertificationTestWindow    @relation(fields: [windowId], references: [id], onDelete: Cascade)
  userProfile   UserProfile                @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  questions     CertificationAttemptQuestion[]
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt

  @@unique([windowId, userProfileId])
  @@index([userProfileId])
  @@index([status])
}

model CertificationAttemptQuestion {
  id                     String               @id @default(uuid())
  attemptId              String
  displayOrder           Int
  questionIdOriginal     String
  promptSnapshot         String
  optionsSnapshotJson    Json
  selectedOptionIdOriginal String?
  isFlagged              Boolean              @default(false)
  answeredAt             DateTime?
  attempt                CertificationAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@unique([attemptId, displayOrder])
  @@index([attemptId])
}
